import streamlit as st
import google.generativeai as genai
import time

# ============================================
# CONFIGURATION DE LA PAGE
# ============================================
st.set_page_config(
    page_title="Chatbot SVB - Assistant Virtuel",
    page_icon="üí¨",
    layout="centered",
    initial_sidebar_state="collapsed"
)

# ============================================
# STYLES PERSONNALIS√âS
# ============================================
st.markdown("""
<style>
    /* Fond d√©grad√© Saint-Valentin */
    .stApp {
        background: linear-gradient(135deg, #FFB6C1 0%, #FFF5F7 50%, #FFE4E8 100%);
    }
    
    /* Header personnalis√© */
    .main-header {
        text-align: center;
        padding: 20px 0;
        margin-bottom: 30px;
    }
    
    .main-header h1 {
        color: #E74C3C;
        font-size: 3em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .subtitle {
        color: #FF69B4;
        font-size: 1.2em;
        font-weight: 600;
    }
    
    /* Messages du chatbot */
    .stChatMessage {
        background-color: white;
        border-radius: 15px;
        padding: 15px;
        margin: 10px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Boutons */
    .stButton>button {
        background: linear-gradient(135deg, #FF69B4, #E74C3C);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 10px 30px;
        font-weight: 700;
        transition: all 0.3s;
    }
    
    .stButton>button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
    }
    
    /* Zone de texte */
    .stTextInput>div>div>input {
        border-radius: 25px;
        border: 2px solid #e5e7eb;
        padding: 12px 20px;
    }
    
    .stTextInput>div>div>input:focus {
        border-color: #FF69B4;
        box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.1);
    }
    
    /* Sidebar */
    .css-1d391kg {
        background-color: white;
    }
    
    /* Success/Error boxes */
    .success-box {
        background-color: #d1fae5;
        color: #065f46;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #10b981;
        margin: 20px 0;
    }
    
    .error-box {
        background-color: #fee2e2;
        color: #991b1b;
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #dc2626;
        margin: 20px 0;
    }
    
    /* Info box */
    .info-box {
        background-color: #FFF5F7;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #FF69B4;
        margin: 20px 0;
    }
</style>
""", unsafe_allow_html=True)

# ============================================
# CONTEXTE SVB POUR GEMINI
# ============================================
SVB_CONTEXT = """Tu es l'assistant virtuel du studio SVB SantezVousBien √† Saint-Ouen-sur-Seine, France.

INFORMATIONS CL√âS :

üìç LOCALISATION :
- 2 studios √† Saint-Ouen (93400)
- Studio Parc des Docks : 6 Mail Andr√© Breton - Coaching individuel & Small Group Training
- Studio Cours Lavandi√®res : 40 Cours des Lavandi√®res - Pilates Reformer, Crossformer & Yoga
- M√©tro : Mairie de Saint-Ouen (Ligne 14)
- Les 2 studios sont √† 5 minutes √† pied l'un de l'autre

üìû CONTACT :
- T√©l√©phone/WhatsApp : 07 44 91 91 55
- Email : hello@studiosvb.fr
- Instagram : @svb.officiel
- Site web : studiosvb.com

üí∞ TARIFS PRINCIPAUX :
- NEW Pass Starter : 99,90‚Ç¨ (5 sessions diff√©rentes, sans engagement, valable 1 mois)
- Pass Crossformer (50 min) : 78,30‚Ç¨ √† 408,30‚Ç¨/mois (2 √† 12 sessions)
- Pass Reformer (50 min) : 70,30‚Ç¨ √† 360,30‚Ç¨/mois (2 √† 12 sessions)
- Pass Full Former (50 min) : 74,30‚Ç¨ √† 384,30‚Ç¨/mois (Reformer + Crossformer)
- Pass Cross (55 min) : 30,30‚Ç¨ √† 168,30‚Ç¨/mois (2 √† 12 sessions)
- Pass Focus (55 min) : 36,30‚Ç¨ √† 192,30‚Ç¨/mois (2 √† 12 sessions)
- Pass Full (55 min) : 40,30‚Ç¨ √† 210,30‚Ç¨/mois (Cross + Focus)
- Coaching Priv√© : 300,30‚Ç¨/mois (4 s√©ances) ou 560,30‚Ç¨/mois (8 s√©ances)
- Pass Kids : 35,30‚Ç¨/mois (2 sessions) ou 65,30‚Ç¨/mois (4 sessions)

‚ú® S√âANCES D'ESSAI :
- Machines (Reformer/Crossformer) : 30‚Ç¨ (15‚Ç¨ rembours√©s si inscription)
- Small Group (Cross/Focus) : 30‚Ç¨ (15‚Ç¨ rembours√©s si inscription)

üèãÔ∏è COURS DISPONIBLES :
Machines : Pilates Reformer, Crossformer, Hatha Flow, Yoga Vinyasa, Classic Pilates, Power Pilates, Core & Strech
Training : Cross Training, Cross Body, Cross Core, Cross Yoga, Cross Rox, Boxe, Groove & Tone, Afrodanc'All, Yoga Kids, Training Kids

üöÄ OPTION SVB BOOST (9,90‚Ç¨/mois) :
- Frais d'inscription offerts (49‚Ç¨)
- 1 essai gratuit/mois pour un proche
- Engagement r√©duit
- Suspension d'abonnement possible

üìã R√àGLES IMPORTANTES :
- Frais de dossier : 49‚Ç¨ (offerts avec Option Boost)
- Engagement 6 mois pour Pass 2 sessions, 3 mois pour les autres
- Annulation small group : jusqu'√† 1h avant
- Annulation coaching priv√© : jusqu'√† 24h avant
- Retard +5 min = cours refus√©
- Chaussettes antid√©rapantes OBLIGATOIRES pour les machines

CONSIGNES DE R√âPONSE :
- R√©ponds de mani√®re chaleureuse, concise et professionnelle
- Utilise des emojis pour rendre tes r√©ponses vivantes (mais pas trop)
- Si tu ne connais pas l'information exacte, invite √† contacter le studio au 07 44 91 91 55
- Adapte ton ton : amical mais professionnel
- Propose toujours une action concr√®te (r√©server, appeler, visiter le site)
- Maximum 200 mots par r√©ponse sauf si la question n√©cessite plus de d√©tails"""

# ============================================
# INITIALISATION DE L'APPLICATION
# ============================================

# Initialiser l'√©tat de session
if "messages" not in st.session_state:
    st.session_state.messages = []

if "gemini_configured" not in st.session_state:
    st.session_state.gemini_configured = False

# ============================================
# CONFIGURATION DE GEMINI
# ============================================
def configure_gemini():
    """Configure l'API Gemini avec la cl√© depuis les secrets"""
    try:
        # R√©cup√©rer la cl√© API depuis les secrets Streamlit
        api_key = st.secrets.get("GEMINI_API_KEY", "")
        
        if not api_key:
            return False
            
        genai.configure(api_key=api_key)
        st.session_state.gemini_configured = True
        return True
        
    except Exception as e:
        st.error(f"Erreur de configuration : {str(e)}")
        return False

# ============================================
# FONCTION POUR OBTENIR LA R√âPONSE DE GEMINI
# ============================================
def get_gemini_response(user_message):
    """Obtient une r√©ponse de Gemini"""
    try:
        model = genai.GenerativeModel('gemini-pro')
        
        # Construire l'historique de conversation
        chat_history = [
            {"role": "user", "parts": [SVB_CONTEXT]}
        ]
        
        # Ajouter l'historique des messages
        for msg in st.session_state.messages:
            role = "user" if msg["role"] == "user" else "model"
            chat_history.append({
                "role": role,
                "parts": [msg["content"]]
            })
        
        # D√©marrer le chat
        chat = model.start_chat(history=chat_history)
        
        # Envoyer le message
        response = chat.send_message(user_message)
        
        return response.text
        
    except Exception as e:
        return f"‚ùå Erreur : {str(e)}\n\nContactez-nous directement au 07 44 91 91 55"

# ============================================
# INTERFACE PRINCIPALE
# ============================================

# Header
st.markdown("""
<div class="main-header">
    <h1>üí¨ Chatbot SVB</h1>
    <p class="subtitle">ü§ñ Propuls√© par Google Gemini AI</p>
</div>
""", unsafe_allow_html=True)

# Sidebar pour la configuration
with st.sidebar:
    st.title("‚öôÔ∏è Configuration")
    
    # V√©rifier si la cl√© API est configur√©e
    if configure_gemini():
        st.markdown('<div class="success-box">‚úÖ API Gemini configur√©e</div>', unsafe_allow_html=True)
        
        st.markdown("---")
        st.markdown("### üìä Statistiques")
        st.metric("Messages envoy√©s", len([m for m in st.session_state.messages if m["role"] == "user"]))
        st.metric("R√©ponses re√ßues", len([m for m in st.session_state.messages if m["role"] == "assistant"]))
        
        st.markdown("---")
        if st.button("üóëÔ∏è Effacer la conversation"):
            st.session_state.messages = []
            st.rerun()
            
        st.markdown("---")
        st.markdown("""
        ### üìû Contact SVB
        - üì± 07 44 91 91 55
        - ‚úâÔ∏è hello@studiosvb.fr
        - üì∏ @svb.officiel
        """)
        
    else:
        st.markdown('<div class="error-box">‚ùå Cl√© API Gemini non configur√©e</div>', unsafe_allow_html=True)
        
        st.markdown("""
        ### üîë Configuration requise
        
        Pour utiliser ce chatbot, vous devez :
        
        1. Obtenir une cl√© API Gemini (gratuit)
        2. L'ajouter dans les secrets Streamlit
        
        **Comment faire :**
        
        1. Allez sur [Google AI Studio](https://makersuite.google.com/app/apikey)
        2. Cr√©ez une cl√© API
        3. Dans Streamlit Cloud :
           - Allez dans Settings ‚Üí Secrets
           - Ajoutez :
           ```
           GEMINI_API_KEY = "votre_cl√©_ici"
           ```
        4. Red√©marrez l'app
        """)

# Zone de messages
if not st.session_state.gemini_configured:
    st.markdown("""
    <div class="info-box">
        <h3>üëã Bienvenue !</h3>
        <p>Pour utiliser le chatbot SVB, veuillez configurer votre cl√© API Gemini dans le panneau de gauche.</p>
        <p>Une fois configur√©e, vous pourrez poser toutes vos questions sur SVB SantezVousBien !</p>
    </div>
    """, unsafe_allow_html=True)
else:
    # Afficher l'historique des messages
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
    
    # Afficher le message de bienvenue si c'est la premi√®re fois
    if len(st.session_state.messages) == 0:
        with st.chat_message("assistant"):
            welcome_msg = "üëã Bonjour ! Je suis l'assistant virtuel de SVB SantezVousBien.\n\nComment puis-je vous aider aujourd'hui ?"
            st.markdown(welcome_msg)
    
    # Zone de saisie
    if prompt := st.chat_input("Posez votre question..."):
        # Ajouter le message de l'utilisateur
        st.session_state.messages.append({"role": "user", "content": prompt})
        
        # Afficher le message de l'utilisateur
        with st.chat_message("user"):
            st.markdown(prompt)
        
        # Obtenir et afficher la r√©ponse
        with st.chat_message("assistant"):
            with st.spinner("ü§î Je r√©fl√©chis..."):
                response = get_gemini_response(prompt)
                st.markdown(response)
        
        # Ajouter la r√©ponse √† l'historique
        st.session_state.messages.append({"role": "assistant", "content": response})

# Footer
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #6b7280; font-size: 0.9em;">
    <p>üíö SVB SantezVousBien - Saint-Ouen-sur-Seine</p>
    <p>Propuls√© par Google Gemini AI | Cr√©√© avec Streamlit</p>
</div>
""", unsafe_allow_html=True)